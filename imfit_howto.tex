\documentclass[10pt]{article}
\usepackage[]{mathpazo}
% FOLLOWING DOES NOT WORK [URW Garamond NOT INSTALLED?]
%\usepackage[garamond]{mathdesign}
% FOLLOWING DOES NOT WORK [SOME METRIC FILES ARE MISSING]
%\usepackage[]{mathtime}
% FOLLOWING DOES NOT WORK [EULER FONTS NOT INSTALLED?]
%\usepackage[]{mathpple}

\usepackage{natbib}
\usepackage{hyperref}
\usepackage{color}

\usepackage{listings}
\lstset{language=C}

\setlength{\oddsidemargin}{1.0cm}
\setlength{\textwidth}{13.5cm}

\newcommand{\imfit}{\texttt{imfit}}
\newcommand{\Imfit}{\texttt{Imfit}}
\newcommand{\makeimage}{\texttt{makeimage}}

\newcommand{\red}{\textcolor{red}}



\begin{document}

% Definition of title page:
\title{
  Notes for Using ``Imfit''
}
\author{
  Peter Erwin\\
  MPE and USM\\
  \href{mailto:erwin@sigmaxi.net}{erwin@sigmaxi.net}
}
\date{\today}  % optional

\maketitle

\tableofcontents


\section{What Is It?}

\Imfit{} is a program for fitting astronomical images --- more
specifically, for fitting images of galaxies, though it can in principle
be used for fitting other sources. The user specifies a set of one or
more 2D functions (e.g., elliptical exponential, elliptical S\'ersic,
circular Gaussian) which will be added together in order to generate a
model image; this model image will then be matched to the input image by
adjusting the 2D function parameters via nonlinear minimization of the total
$\chi^2$.

The 2D functions can be grouped into arbitrary sets sharing a common $(x,y)$
position on the image plane; this allows galaxies with off-center components
or multiple galaxies to be fit simultaneously. Parameters for the inividual
functions can be held fixed or restricted to user-specified ranges. The
model image can (optionally) be convolved with a Point Spread
Function (PSF) image to better match the input image; the PSF image can
be any square, centered image the user supplies (e.g., an analytic 2D Gaussian
or Moffat, a \textit{Hubble Space Telescope} PSF generated by the TinyTim
program \cite{krist95}\footnote{\url{http://www.stsci.edu/hst/observatory/focus/TinyTim}}, 
or an actual stellar image).

A key characteristic of \imfit{} is a modular, object-oriented design
that allows relatively easy addition of new, user-specified 2D image
functions. This is accomplished by writing C++ code for a new
image-function class (this can be done by copying and modifying an
existing pair of \texttt{.h/.cpp} files for one of the pre-supplied
image functions), modifying one additional file to include references to
the new function, and re-compiling the program. Notes are [WILL BE] provided
to guide the interested user in adding new functions; in most cases, a
basic working knowledge of C should suffice.

Additional auxiliary programs built from the same codebase exist for
generating artificial galaxy images (using the same input/output
parameter-file format as \imfit{}).

\Imfit{} is an open-source project; the source code is freely available
under the GNU Public License (GPL).


\bigskip

\textbf{System Requirements:} \Imfit{} has been built and tested on
Intel-based MacOS X and Linux (Ubuntu) systems. It uses standard C++ and
should work on any Unix-style system with a modern C++ compiler and the
Standard Template Library (e.g., GCC v4 or higher). It relies on two
external, open-source libraries: version 3 of the CFITSIO
library\footnote{\url{http://heasarc.nasa.gov/fitsio/}} for FITS image I/O and
version 3 of the FFTW (Fastest Fourier Transform in the West)
library\footnote{\url{http://www.fftw.org/}} for PSF convolution.

MORE CREDITS -- e.g., Craig Markwardt's lmfit code; Differential Evolution
code; C++ interface to DE.



\section{Getting/Installing \Imfit{}}

\subsection{Pre-Compiled Binaries}

Pre-built binaries for Intel-based MacOS X and Linux systems are available XXX.


\subsection{Compiling from Source: Outline}

\begin{enumerate}
\item Install CFITSIO

\item Install FFTW

\item (Optional) Install GNU Scientific Library (GSL) --- this is only necessary
if you wish to use 2D image functions that rely on GSL; currently, the only
such function is the EdgeOnDisk (\texttt{func\_edge-on-disk.cpp}) component.

\item Install SCons

\item Build \imfit{}

\end{enumerate}

\subsection{Building \Imfit{} from Source}

Assuming that CFITSIO and FFTW (and optionally GSL) are already installed
on your system, XXX

\Imfit{} uses SCons for the build process; SCons is a Python-based build system
that is somewhat easier to use and more flexible than the traditional \texttt{make}
system. SCons can be downloaded from \url{http://www.scons.org/}.

Assuming things are simple [HA!], you should build \imfit{} and the companion
program \makeimage{} with the following commands:
\begin{quote}
\texttt{\$ scons imfit} \\
\texttt{\$ scons makeimage}
\end{quote}
This will produce two binary executable files: \imfit{} and \makeimage{}. Copy
these to some convenient place on your path.

If you do not have GSL installed, you will get compilation errors; use the following
commands instead:
\begin{quote}
\texttt{\$ scons define=NO\_GSL imfit} \\
\texttt{\$ scons define=NO\_GSL makeimage}
\end{quote}

\subsubsection{Options: Multithreaded Programs}

Mainly useful for making PSF convolution go faster ... Requires that FFTW
have been compiled with threading support turned on.

\begin{quote}
\texttt{\$ scons define=FFTW\_THREADING imfit} \\
\texttt{\$ scons define=FFTW\_THREADING makeimage}
\end{quote}





\section{Using \Imfit{}}

Basic use of \imfit{} from the command line looks like this:
\begin{quote}
  \texttt{\$ \imfit{} }  -c \textit{config-file} ~ \textit{input-image} ~ [options]
\end{quote}
where \textit{config-file} is the name of the configuration file
which describes the model (the combination of 2D functions, initial values
for parameters, and possible limits on parameter values) and \textit{input-image}
is the FITS image we want to fit with the model.

The ``options'' are a set of command-line flags and options (use ``\imfit{} \texttt{-h}''
or `\imfit{} \texttt{--help}'' to see the complete list). Options must be followed by
an appropriate value (e.g., a filename, an integer, a floating-point number); this can
be separated from the option by a space, or they can be connected with an equals sign.
In other words, both of the following are valid:
\begin{quote}
imfit ~ \texttt{--}gain 2.5 \\
imfit ~ \texttt{--}gain=2.5
\end{quote}
Note that \imfit{} does not follow the full GNU standard for
command-line options and flags (as implemented by, e.g., the GNU
\texttt{getopt} library): you cannot merge multiple one-character flags
into a single item (if ``\texttt{-a}'' and ``\texttt{-b}'' are flags,
``\texttt{-a -b}'' will work, but ``\texttt{-ab}'' will not), and you
cannot merge a one-character option and its target
(``\texttt{-csomefile.dat}'' is \textit{not} a valid substitute for
``\texttt{-c somefile.dat}'').

\bigskip

Some notable/useful comand-line flags and options include:
\begin{itemize}
\item \texttt{--psf} \textit{psf-image} --- specifies a FITS image to be convolved
with the model image.

\bigskip

\item \texttt{--mask} \textit{mask-image} --- specifies a FITS image which marks
bad pixels to be ignored in the fitting process (by default, zero values in
the mask indicate \textit{good} pixels, and positive values indicate bad pixels).
\item \texttt{--mask-zero-is-bad} --- indicates that zero values (actually,
any value $< 1.0$) in the mask correspond to \textit{bad} pixels, with values
$\geq 1.0$ being good pixels.

\bigskip

\item \texttt{--noise} \textit{noisemap-image} --- specifies a pre-existing noise
or error FITS image to use in the fitting process (by default, pixel values in the
noise map are assumed to be sigma values).
\item \texttt{--errors-are-variances} --- indicates that pixel values in the noise
map are variances (sigma$^2$) instead of sigmas.
\item \texttt{--errors-are-weights} --- indicates that pixel values in the noise
map should be interpreted as weights, not as sigmas or variances.

\bigskip

\item \texttt{--sky} \textit{sky-level} --- specifies an original sky background
level (in counts/pixel) that was subtracted from the image; used for internal
computation of the noise map.
\item \texttt{--gain} \textit{sky-level} --- specifies the A/D gain (electrons/pixel)
of the input image; used for internal computation of the noise map.
\item \texttt{--readnoise} \textit{value} --- specifies the read noise (electrons)
of the input image; used for internal computation of the noise map.
\item \texttt{--ncombined} \textit{value} --- if values in the input image are the
result of averaging (or computing the median of) two or more original images, then
this should be used to specify the number of original images; used for internal 
computation of the noise map.  If multiple images were \textit{added} together
with no rescaling, then do not use this option.

\bigskip

\item \texttt{--save-params} \textit{output-filename} --- specifies that parameters 
for best-fitting model should be saved using the specified filename (default is
for these to be saved in a file named \texttt{bestfit\_parameters\_imfit.dat}).
\item \texttt{--save-model} \textit{output-filename} --- the best-fitting model image
will be saved using the specified filename.
\item \texttt{--save-residual} \textit{output-filename} --- the residual image (input
image $-$ best-fitting model image) will be saved using the specified filename.

\bigskip
\item \texttt{--de} --- use Differential Evolution instead of Levenberg-Marquardt as
the minimization technique (WARNING: much slower!)
\item \texttt{--chisquare-only} --- Evalute the $\chi^2$ value for the initial input
model as a fit to the input image, \textit{without} doing any minimization to find
a better solution.
\end{itemize}




\section{Trying It Out}

In the \texttt{examples/} directory are XXX.

The simplest way to run \imfit{} is:
\begin{quote}
imfit ~ ic3478rss\_256.fits ~ \texttt{-c} ~ config\_sersic\_ic3478\_256.dat ~ \texttt{--}mask ~ ic3478rss\_256\_mask.fits ~ \texttt{--}gain=4.725 \texttt{--}readnoise=4.3 ~ \texttt{--}sky=130.14
\end{quote}

This converges to a fit in about 2.5 seconds on a 2009 MacBook Pro (2.8 GHz Core 2 Duo processor).

Note that you can specify a subset of an image, thus:
\begin{quote}
imfit ~ ic3478rss\_256.fits[45:150,200:310] ~ [rest of options]
\end{quote}
This will fit columns 45--150 and rows 200--310 of the image (column and row numbering starts
at 1); pixel coordinates in the configuration file should refer to locations within the
full image.

You can also fit the image using PSF convolution, by adding the ``\texttt{--psf}'' option and a
valid FITS image for the PSF; the \texttt{examples} directory contains a Moffat PSF image which
matches stars in the original image fairly well:
\begin{quote}
imfit ~ ic3478rss\_256.fits ~ \texttt{-c} ~ config\_sersic\_ic3478\_256.dat ~ \texttt{--}mask ~ ic3478rss\_256\_mask.fits ~ \texttt{--}gain=4.725 \texttt{--}readnoise=4.3 ~ \texttt{--}sky=130.14 ~ \texttt{--}psf ~ psf\_moffat\_51.fits
\end{quote}


The PSF image was generated using the companion program \makeimage{} and the configuration
file \texttt{makeimage\_config\_moffat\_psf\_51\_for\_ic3478rss.dat}:
\begin{quote}
makeimage ~ \texttt{--}ncols=51 ~ \texttt{--}nrows=51 ~ -o ~ psf\_moffat\_51.fits ~ makeimage\_config\_moffat\_psf\_51\_for\_ic3478rss.dat  
\end{quote}



\section{The Configuration File}\label{sec:configfile}

\texttt{Imfit} always requires a configuration file, which specifies the
model which will be fit to the input image, initial values for model parameters, any limits on
parameter values (optional for L-M, required for DE fitting), and
possibly additional information (e.g, gain and read noise for the
input image).

The configuration file should be a plain text file. Blank lines and
lines beginning with ``\#'' are ignored; in fact, anything after a
``\#'' is ignored, which allows for comments at the end of lines.

A model for an image is specified by one or more ``function blocks'',
each of which is a group of one or more 2D image functions sharing a
common $(x,y)$ spatial position. Each function-specification consists of
a line beginning with ``FUNCTION'' and containing the function name,
followed by one or more lines with specifications for that function's parameters.

\bigskip

More formally, the format for a configuration file is:
\begin{enumerate}
\item Optional specifications of general parameters and settings (e.g., the
input image's A/D gain and read noise)
\item One or more function blocks, each of which contains:
\begin{enumerate}
\item X-position parameter-specification line
\item Y-position parameter-specification line
\item One or more function + parameters specifications, each of which contains:
\begin{enumerate}
\item \texttt{FUNCTION} + function-name line
\item one or more parameter-specification lines
\end{enumerate}
\end{enumerate}
\end{enumerate}

This probably sounds more complicated than it is in practice.
Here is a very basic, bare-bones example of a configuration file:

\begin{quote}
  \texttt{X0  ~  150.1}\\
  \texttt{Y0  ~  149.5}\\
  \texttt{FUNCTION   Exponential}\\
  \texttt{PA  ~  95.0}\\
  \texttt{ell  ~  0.45}\\
  \texttt{I\_0 ~  90.0}\\
  \texttt{h   ~  15.0}\\
\end{quote}

This describes a model consisting of a single elliptical exponential
function, with initial values for the $x$ and $y$ position on the image,
the position angle (PA), the ellipticity (ell), the central intensity
(I\_0) in counts/pixel, and the exponential scale length in pixels (h).
None of the parameters have limits on their values.

Here is the same file, with some additional annotations and with limits on
some of the parameters (comments are colored red for clarity):

\begin{quote}
  \texttt{\red{\# This line is a comment}}\\
  
  \texttt{X0 ~~   150.1 ~  148,152}\\
  \texttt{Y0 ~~   149.5 ~  148,152         \red{\# a note}}\\
  \texttt{FUNCTION   Exponential  ~ \red{\# here is a comment}}\\
  \texttt{PA  ~  95.0  ~ 0,180   ~~   \red{\# limits on the position angle}}\\
  \texttt{ell  ~  0.45 ~ 0,1     ~~~ \red{\# ellipticity should always be 0--1}}\\
  \texttt{I\_0 ~  90.0 ~  fixed ~~~ \red{\# keep central intensity fixed}}\\
  \texttt{h    ~ 15.0}\\
\end{quote}

Here we can see the use of comments (lines or parts of lines beginning with
``\#'') and the use of parameter limits in the form of ``lower,upper'': the X0 and Y0 parameters are
required to remain $\geq 148$ and $\leq 152$, the position angle is limited
to 0--180, the ellipticity must be $\geq 0$ and $\leq 1$, and the central
intensity I\_0 is held fixed at its initial value.

Finally, here is a more elaborate example, specifying a model that has
two function blocks, with the first block having two individual
functions (so this could be a model for, e.g., simultaneously fitting
two galaxies, one as S\'ersic + exponential, the other with just an
exponential):

\begin{quote}
  \texttt{\red{\# This line is a comment}}\\
  
  \texttt{GAIN  2.7   \red{\# A/D gain for image in e/ADU}}\\
  \texttt{READNOISE  4.5   \red{\# image read-noise in electrons}}\\
  
  \texttt{\red{\# This is the first function block: Sersic + exponential}}\\
  \texttt{X0 ~~   150.1  ~~ 148,152}\\
  \texttt{Y0 ~~   149.5  ~~ 148,152}\\
  \texttt{FUNCTION   Sersic   \red{\# A Sersic function}}\\
  \texttt{PA  ~  95.0  ~~ 0,180}\\
  \texttt{ell ~   0.05 ~ 0,1}\\
  \texttt{n   ~~   2.5  ~~~ 0.5,4.0 ~~ \red{\# Sersic index}}\\
  \texttt{I\_e ~  20.0 ~~ \red{\# intensity at the half-light radius}}\\
  \texttt{r\_e ~    5.0 ~~ \red{\# half-light radius in pixels}}\\
  \texttt{FUNCTION   Exponential}\\
  \texttt{PA   ~ 95.0  ~~ 0,180}\\
  \texttt{ell  ~  0.45  ~~0,1}\\
  \texttt{I\_0 ~  90.0  ~ fixed}\\
  \texttt{h    ~~ 15.0}\\
  
  \texttt{\red{\# This is the second function block: just a single exponential}}\\
  \texttt{X0 ~~   225.0  ~~ 224,226}\\
  \texttt{Y0 ~~   181.7  ~~ 180,183}\\
  \texttt{FUNCTION   Exponential   \red{\# a different exponential!}}\\
  \texttt{PA   ~ 22.0  ~~ 0,180      }\\
  \texttt{ell  ~  0.25 ~ 0,1}\\
  \texttt{I\_0 ~  10.0  }\\
  \texttt{h   ~~~  20.0}\\
\end{quote}


\subsection{Parameter Names, Specifications, and Values}

The X0/Y0 position lines at the start of each function block and the
individual parameter lines for each function all share a common format:
\begin{quote}
\textit{parameter-name} ~~ \textit{initial-parameter-value} ~~ \textit{optional-limits}
\end{quote}
The separation between the individual pieces must consist of one or more spaces
and/or tabs. The final piece specifying the limits is optional (except that
fitting in Differential Evolution mode \textit{requires} that there be limits
for each parameter).

\bigskip

\textbf{Parameter Names:} The X0/Y0 positional parameters for each
function block must be labeled ``X0'' and ``Y0''. Names for the
parameters of individual functions can be anything the user desires;
only the order matters. Thus, the position-angle parameter could be
labeled ``PA'', ``PosAngle'', ``angle'', or any non-space-containing
string --- though it's a good idea to have it be something relevant
and understandable.

\textbf{Important Note:} Do not change the \textit{order} of the parameters
for a particular function!  Because the strings giving the parameter names
can be anything at all, \imfit{} actually ignores them and simply assumes
that all parameters are in the correct order for each function.

Note that any output which \imfit{} generates will use the default parameter
names defined in the individual function code (use ``\texttt{--list-parameters}''
to see what these are for each function).

\bigskip

\textbf{Values for Positional Parameter (X0, Y0)}: The positional parameters
for each function block are pixel values -- X0 for the column number and
Y0 for the row number. \Imfit{} uses the IRAF pixel-numbering
convention: the center of first pixel in the image (the lower left pixel
in a standard display) is at $(1.0,1.0)$, with the lower-left corner of that
pixel having the coordinates $(0.5,0.5)$.

\bigskip

\textbf{General Parameter Values for Functions}: The meaning of the individual
parameter values for the various 2D image functions is set by the functions
themselves, but in general: 
\begin{itemize}
\item position angles are measured in degrees counter-clockwise
from the image $+y$ axis (i.e., degrees E of N if the image has standard
astronomical orientation);
\item ellipticity $= 1 - b/a$, where $a$ and $b$ are the
semi-major and semi-minor axes of an ellipse;
\item intensities are in counts/pixel;
\item lengths are in pixels. 
\end{itemize}
If you write your own functions, you are encouraged
to stick to these conventions.

\subsection{Parameter Limits}

Individual parameters can be limited in two ways:
\begin{enumerate}
\item Held fixed;
\item Restricted to lie between lower and upper limits.
\end{enumerate}
To hold a parameter fixed, use the string ``fixed'' after the initial-value
specification, e.g.:
\begin{quote}
\texttt{X0} ~~ 442.85 ~~ fixed
\end{quote}
To specify lower and upper limits for a parameter, include them as a comma-separated
pair following the initial-value specification, e.g.:
\begin{quote}
\texttt{X0} ~~ 442.85 ~~ 441.0,443.5
\end{quote}



\section{Standard Image Functions}

\Imfit{} comes with the following 2D image functions, each of
which can be used as many times as desired. (As mentioned above, \imfit{}
is designed so that constructing and using new functions is a relatively
simple process.) Note that elliptical functions can always be made circular
by setting the ``ellipticity'' parameter to 0.0 and specifying that it be
held fixed. See Appendix~\ref{app:functions} for fuller discussions of each
function, including their parameters.

\begin{itemize}
\item FlatSky --- a uniform sky background.
\item Gaussian --- an elliptical 2D Gaussian function.
\item Moffat --- an elliptical 2D Moffat function.
\item Exponential --- an elliptical 2D exponential function.
\item Exponential\_GenEllipse --- an elliptical 2D exponential function using
generalized ellipses (``boxy'' to ``disky'' shapes) for the isophote shapes.
\item S\'ersic --- an elliptical 2D S\'ersic function.
\item Sersic\_GenEllipse --- an elliptical 2D S\'ersic function using
generalized ellipses (``boxy'' to ``disky'' shapes) for the isophote shapes.
\item FlatExponential --- similar to Exponential, but with an inner radial zone
of constant surface brightness for $r < R_{\rm break}$.
\item BrokenExponential --- similar to Exponential, but with \textit{two}
exponential radial zones (with different scalelengths) joined by a transition region
at $R_{\rm break}$ of variable sharpness.
\item GaussianRing --- an elliptical ring with a radial profile
consisting of a Gaussian centered at $r = R_{\rm ring}$.
\item GaussianRing2Side --- like GaussianRing, but with a radial profile
consisting of an asymmetric Gaussian (different values of $\sigma$ for
$r < R_{\rm ring}$ and $r > R_{\rm ring}$).
\item EdgeOnDisk --- the analytical form for a perfectly edge-on exponential
disk, using the Bessel-function solution of \citet{vdk81} for 
the radial profile and the generalized sech function of \citet{vdk88} 
for the vertical profile. Note that this function requires that the GNU
Scientific Library (GSL) be installed; if the GSL is not installed, \imfit{}
will be compiled without the this function.
\item EdgeOnRing --- a simplistic model for an edge-on ring, using a
Gaussian for the radial profile and another Gaussian (with
different $\sigma$) for the vertical profile.
\item EdgeOnRing2Sdie --- like EdgeOnRing, but using an
asymmetric Gaussian for the radial profile (see description of GaussianRing2Side).

%Exponential, Exponential_GenEllipse, Sersic, Sersic_GenEllipse, Gaussian, 
%FlatExponential, BrokenExponential, BrokenExponential2D, EdgeOnDisk, Moffat, 
%FlatSky, EdgeOnDiskN4762, EdgeOnDiskN4762v2, EdgeOnRing, GaussianRing2Side.

\end{itemize}


A list of the currently available functions can always be obtained
by running \imfit{} with the ``\texttt{--list-functions}'' option:
\begin{quote}
  \texttt{\$ IMFIT --list-functions}
\end{quote}
and the complete list of function parameters for each function can always be
obtained by running \imfit{} with the ``\texttt{--list-parameters}'' option:
\begin{quote}
  \texttt{\$ IMFIT --list-parematers}
\end{quote}




\section{Extras for Fitting Images}

\subsection{Masks}

\subsection{Noise, Variance, or Weight Maps}

Note that \imfit{} does \textit{not} [, xxx by default,] try to obtain information
from the FITS header of an image, for two reasons. First, there is little
consistency in header names across the wide range of astronomical images, so
it is difficult pick one name, or even a small set, and assume that it will
be present in a given image's header. Second, XXX
% trying to explain that we don't do the dumb thing that GALFIT does,
% which is to assume that the presence of an EXPTIME keyword means that
% pixel values MUST be divided by EXPTIME ...


\subsection{PSF Convolution}




\section{Rolling Your Own Functions}

\subsection{A Simple Example}

To illustrate how one might make a new function, we'll make a new version of
the Moffat function (which already exists, so this is purely for pedagogical purposes)
by copying and modifying the code for the Gaussian function.

\bigskip

We need to make three sets of changes:
\begin{itemize}
\item Change the class name from ``Gaussian'' to our new name (``NewMoffat'');
\item Change the relevant code which computes the function;
\item Rename, add, or delete variables to accomodate the new algorithm.
\end{itemize}


\subsubsection{Create and Edit the Header File}

Copy the file \texttt{func\_gaussian.h} and rename it to \texttt{func\_new-moffat.h}. 
Edit this file and change the following lines:

\begin{verbatim}
#define CLASS_SHORT_NAME  "Gaussian"
\end{verbatim} 
(replace \texttt{"Gaussian"} with \texttt{"NewMoffat"})

\begin{verbatim}
class Gaussian : public FunctionObject
\end{verbatim}
(replace \texttt{Gaussian} with \texttt{NewMoffat})

\begin{verbatim}
    Gaussian( );
\end{verbatim}
(replace \texttt{Gaussian} with \texttt{NewMoffat})

And finally edit the list of class data members, changing this:
\begin{verbatim}
  private:
    double  x0, y0, PA, ell, I_0, sigma;   // parameters
    double  q, PA_rad, cosPA, sinPA;   // other useful (shape-related) quantities
\end{verbatim}
to this:
\begin{verbatim}
  private:
    double  x0, y0, PA, ell, I_0, fwhm, beta;   // parameters
    double  alpha;
    double  q, PA_rad, cosPA, sinPA;   // other useful (shape-related) quantities
\end{verbatim}


\subsubsection{Create and Edit the Class File}

Copy the file \texttt{func\_gaussian.cpp} and rename it to \texttt{func\_new-moffat.cpp}. 

\bigskip
\noindent \textit{Initial changes, including parameter number and names:}
\smallskip

Edit this file and change the following lines (changed text indicated in red):

\begin{quote}
\texttt{\#include "\red{func\_new-moffat.h}"} \\

const int  N\_PARAMS = \red{5}; \\

const char  PARAM\_LABELS[][20] = \{"PA", "ell", "I\_0", \red{"fwhm", "beta"}\}; \\

const char  FUNCTION\_NAME[] = "\red{Moffat} function";

\end{quote}

\bigskip
\noindent \textit{Change references to class name:}
\smallskip

Change all class references from ``Gaussian'' to ``NewMoffat'' (e.g., \texttt{Gaussian::Setup}
becomes \texttt{NewMoffat::Setup}).

\bigskip
\noindent \textit{Changes to Setup method:}
\smallskip

In the Setup method, you need to change how the input is converted into
parameters, and do any useful pre-computations. So the initial processing of
the ``params'' input changes from this:
\begin{verbatim}
  PA = params[0 + offsetIndex];
  ell = params[1 + offsetIndex];
  I_0 = params[2 + offsetIndex ];
  sigma = params[3 + offsetIndex ];
\end{verbatim}

to this:
\begin{verbatim}
  PA = params[0 + offsetIndex];
  ell = params[1 + offsetIndex];
  I_0 = params[2 + offsetIndex ];
  fwhm = params[3 + offsetIndex ];
  beta = params[4 + offsetIndex ];
\end{verbatim}
and at the end we replace this:
\begin{verbatim}
  twosigma_squared = 2.0 * sigma*sigma;
\end{verbatim}
with this:
\begin{verbatim}
  // compute alpha:
  double  exponent = pow(2.0, 1.0/beta);
  alpha = 0.5*fwhm/sqrt(exponent - 1.0);
\end{verbatim}


\bigskip
\noindent \textit{Changes to CalculateIntensity method:}
\smallskip

This is the key place where your new function's algorithm is
implemented: the computation of the intensity as a function of (scaled)
radius.  Replace the original version of this method with the following:
\begin{verbatim}
double Moffat::CalculateIntensity( double r )
{
  double  scaledR, denominator;
  
  scaledR = r / alpha;
  denominator = pow((1.0 + scaledR*scaledR), beta);
  return (I_0 / denominator);
}
\end{verbatim}

\bigskip

In this simple example, we aren't changing the isophote geometry (i.e.,
we're still assuming a perfectly elliptical shape), so we don't need to
change the GetValue method, which converts pixel position to a scaled
radius value.  It probably doesn't make sense to change the
CalculateSubsamples method, either, so we can leave that alone.

At this point, most of the work is done.  We only need to update
\texttt{add\_functions.cpp} so it knows about the new function and
update the SConstruct file so that the new function is included in the
compilation.


\subsubsection{Edit add\_functions.cpp}

We need to do three simple things here:
\begin{enumerate}
\item Include the header file for our new function. Add the following line near
the top of the file, where the other header files are included:\\
\texttt{\#include "func\_new-moffat.h"}

\item Modify the list of function names: XXX

\item Add code to generate an instance of our new class as part of the
function-factory map. Inside the function PopulateFactoryMap, add the following lines:
\begin{verbatim}
  NewMoffat::GetClassShortName(classFuncName);
  input_factory_map[classFuncName] = new funcobj_factory<NewMoffat>();
\end{verbatim}

\end{enumerate}



\subsubsection{Edit the SConstruct File}

In the SConstruct file, locate the place where the variable
``functionobject\_obj\_string'' is defined. This is a string containing
a compact list of all the function-object code filenames. Insert our new
function's name (``func\_new-moffat'') into the list.










\appendix
\section{Standard Functions in Detail}\label{app:functions}

\subsection{FlatSky}

\subsection{Gaussian}

an elliptical 2D Gaussian function.


\subsection{Moffat}

an elliptical 2D Moffat function.


\subsection{Exponential}

an elliptical 2D exponential function.


\subsection{Exponential\_GenEllipse}

an elliptical 2D exponential function using generalized ellipses (``boxy'' to ``disky'' shapes).

\subsection{S\'ersic}

an elliptical 2D S\'ersic function.


\subsection{Sersic\_GenEllipse}
an elliptical 2D S\'ersic function using
generalized ellipses (``boxy'' to ``disky'' shapes).


\subsection{FlatExponential} 

similar to Exponential, but with an inner radial zone
of constant surface brightness.


\subsection{BrokenExponential}

similar to Exponential, but with \textit{two}
exponential radial zones (with different scalelengths) joined by a transition region
at $R_{\rm break}$ of variable sharpness.


\subsection{GaussianRing}

an elliptical ring with a radial profile
consisting of a Gaussian centered at $r = R_{\rm ring}$.


\subsection{GaussianRing2Side}

an elliptical ring with a radial profile
consisting of an asymmetric Gaussian (different values of $\sigma$ for
$r < R_{\rm ring}$ and $r > R_{\rm ring}$).


\subsection{EdgeOnDisk}

the analytical form for a perfectly edge-on exponential
disk, using the Bessel-function solution of van der Kruit \& Searle (1981) for 
the radial profile and the generalized sech function of van der Kruit (1988) 
for the vertical profile. Note that this function requires that the GNU
Scientific Library (GSL) be installed; if the GSL is not installed, \imfit{}
will be compiled without the this function.


\subsection{EdgeOnRing}

a simplistic model for an edge-on ring, using an


\subsection{EdgeOnRing2Side}




\bibliographystyle{plainnat}

\begin{thebibliography}{}

\bibitem[Krist(1995)]{krist95} Krist, J. 1995, ``Simulation of HST PSFs using Tiny Tim'', 
in \textit{Astronomical Data Analysis Software and Systems IV}, 
R.A. Shaw, H.E. Payne, and J.J.E. Hayes, eds., \textit{ASP Conference Series} \textbf{77}: 349.

\bibitem[S{\'e}rsic(1968)]{sersic68} Se{\'e}rsic, J.-L. 1968, \textit{Atlas de 
Galaxias Australes} (Cordoba: Obs.\ Astron.)

\bibitem[van der Kruit \& Searle(1981)]{vdk81} van der Kruit, P. C., \&
Searle, L. 1981, ``Surface Photometry of Edge-on Spiral Galaxies: I. A
Model for the Three-dimensional Distribution of Light in Galactic
Disks'', \textit{Astron.\ Astrophys.} \textbf{95}: 105

\bibitem[van der Kruit(1988)]{vdk88} van der Kruit, P. 1988, ``The
Three-dimensional Distribution of Light and Mass in Disks of Spiral
Galaxies'', \textit{Astron.\ Astrophys.} \textbf{192}: 117


\end{thebibliography}
%\bibliography{imfit_howto}




\end{document}
